<!DOCTYPE html>
<html>
<head>
  <title> self.name </title>
  <link rel="stylesheet" href="/style.css">
  <script type="text/javascript">[% memorable_wordlist::JAVASCRIPT as UTF8 %]</script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.5/mode-latex.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      TeX: { equationNumbers: { autoNumber: "AMS" } },
      "HTML-CSS": { availableFonts: ["TeX"] }
    });
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"],
        bcancel: ["Extension","cancel"],
        xcancel: ["Extension","cancel"],
        cancelto: ["Extension","cancel"]
      });
    });
  </script>
  <style type="text/css" media="screen">
    #editor {
        width: 49%;
        height: 12em;
    }
    .preview {
        background-color: #ffffff;
        margin-left: 50%;
      width: 49%;
        position: absolute;
    }
    .error {
        background-color: #ff6666;
    }
    .error {
        background-color: #ffff66;
    }
</style>
</head>
<body>
  <main>
    <header>
      <h1> Thing Lists </h1>
    </header>
    <p>
      This website allows you to create lists of things that you want to
      occasionally do.  I use this for things like books to reread,
      recipes to make for dinner, or songs to sing to my daughter.  In
      each case, I'd like to have variety, and not do the same thing
      over and over.  But in each case there are also some favorites
      that I want to do more frequently.  Thing Lists attempts to
      determine how frequently you'd like to do each thing based on
      your usage patterns, with a bias towards variety, to help keep
      you from getting in a rut.
    </p>
    <p>
      If you want help with using these lists (or if you use this and
      like it), please feel free to
      <a href="mailto:daveroundy@gmail.com">email me.</a>
    </p>
    <form id="pass-form"
          target="hidden-form"
          onsubmit="var name_element = document.getElementById('the-name');
; window.location.href = passphrase_camel_case(44)+'/'+name_element.value; return false;">
      <label>Create a new list</label>
      <input type="text" name="name" id="the-name">
    </form>
    <iframe style="display:none" name="hidden-form"></iframe>
    <div class="preview", id="preview">
    </div>
    <div id="buffer", class="preview"></div>
    <div id="editor">\paragraph{Test}
This is \emph{nice} \LaTeX.
\begin{align}
f(x) &= x^2 + e^x \\
g(x) &= \frac1{1+x^2}
\end{align}
    </div>
  </main>
  <script>
var Preview = {
  delay: 150,        // delay after keystroke before updating

  preview: null,     // filled in by Init below
  buffer: null,      // filled in by Init below

  timeout: null,     // store setTimout id
  mjRunning: false,  // true when MathJax is processing
  mjPending: false,  // true when a typeset has been queued
  oldText: null,     // used to check if an update is needed
  math_html: null,   // used to store the new html we want

  //
  //  Get the preview and buffer DIV's
  //
  Init: function () {
    this.preview = document.getElementById("preview");
    this.buffer = document.getElementById("buffer");
  },

  //
  //  Switch the buffer and preview, and display the right one.
  //  (We use visibility:hidden rather than display:none since
  //  the results of running MathJax are more accurate that way.)
  //
    SwapBuffers: function () {
    var buffer = this.preview, preview = this.buffer;
    this.buffer = buffer; this.preview = preview;
    buffer.style.visibility = "hidden"; // buffer.style.position = "absolute";
        // preview.style.position = "";
    preview.style.visibility = "";
  },

  //
  //  Creates the preview and runs MathJax on it.
  //  If MathJax is already trying to render the code, return
  //  If the text hasn't changed, return
  //  Otherwise, indicate that MathJax is running, and start the
  //    typesetting.  After it is done, call PreviewDone.
  //
  CreatePreview: function () {
    Preview.timeout = null;
    if (this.mjPending) return;
    var text = this.math_html;
    if (text === this.oldtext) return;
    if (this.mjRunning) {
      this.mjPending = true;
      MathJax.Hub.Queue(["CreatePreview",this]);
    } else {
      this.buffer.innerHTML = this.oldtext = text;
      this.mjRunning = true;
      MathJax.Hub.Queue(
	        ["Typeset",MathJax.Hub,this.buffer],
	        ["PreviewDone",this]
      );
    }
  },

  //
  //  Indicate that MathJax is no longer running,
  //  and swap the buffers to show the results.
  //
    PreviewDone: function () {
    this.mjRunning = this.mjPending = false;
    this.SwapBuffers();
  }

};

//
//  Cache a callback to the CreatePreview action
//
Preview.Init();
Preview.callback = MathJax.Callback(["CreatePreview",Preview]);
Preview.callback.autoReset = true;  // make sure it can run more than once
var my_timeout = null;
    function update_preview() {
        var request = new XMLHttpRequest();
        request.open('POST', '/render');
        request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        request.onload = function() {
            Preview.math_html = request.responseText;
            if (request.status >= 200 && request.status < 400) {
                // Success!
                Preview.CreatePreview();
                // document.getElementById('preview').innerHTML = request.responseText;
            } else {
                // We reached our target server, but it returned an error
                Preview.CreatePreview();
                // document.getElementById('preview').innerHTML = request.responseText;
            }
            MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
        };
        request.onerror = function() {
            // There was a connection error of some sort
        };
        request.send(editor.getValue());
    }
    var preview = document.getElementById('preview');
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/latex");
    editor.renderer.setShowGutter(false);
    update_preview(editor.getValue());
    editor.session.on('change', function(delta) {
        // preview.innerHTML = editor.getValue();
        if (my_timeout) {
            clearTimeout(my_timeout);
        }
        my_timeout = setTimeout(update_preview, 150);
    });
  </script>
</body>
</html>


