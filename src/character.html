<!DOCTYPE html>
<html>

<head>
    <title>[% self.name %]</title>
    <!-- <link rel="stylesheet" href="character.css"> -->
    <script type="text/javascript">[% memorable_wordlist:: JAVASCRIPT as UTF8 %]</script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<style>
    [contenteditable] {
        transition: background-color 0.5s ease-in-out;
        border-radius: 0.25em;
    }

    body {
        color: #ffffe0;
        background-color: black;
    }

    .newrow {
        float: right;
    }

    summary {
        display: inline-block;
    }

    .table {
        display: grid;
        grid-template-columns: fit-content(20em) fit-content(20em) fit-content(20em) fit-content(20em) fit-content(20em) fit-content(20em);
        gap: 0.5em;
    }

    .table .row {
        display: contents;
    }
    .row *:first-child {
        grid-column: 1;
    }
</style>

<script type="text/javascript">
    function randomColor(brightness) {
        function randomChannel(brightness) {
            var r = 255 - brightness;
            var n = 0 | ((Math.random() * r) + brightness);
            var s = n.toString(16);
            return (s.length == 1) ? '0' + s : s;
        }
        return '#' + randomChannel(brightness) + randomChannel(brightness) + randomChannel(brightness);
    }
    function goWhite() {
        var elems = document.querySelectorAll('*'), i;
        for (i = 0; i < elems.length; ++i) {
            let elem = elems[i];
            elem.style.backgroundColor = '';
        }
    }
    let mycolor = randomColor(10);
    const ws = new WebSocket('ws://' + location.host + '/sheets/ws/[% self.code %]/[% self.name %]');
    console.log('did websocket');
    ws.onopen = function () {
        console.log('connected');

        var elems = document.querySelectorAll('[contenteditable]'), i;
        for (i = 0; i < elems.length; ++i) {
            let elem = elems[i];
            elem.addEventListener('input', function () {
                var id = elem.id;
                if (id == '') {
                    id = elem.parentElement.id;
                }
                ws.send(JSON.stringify({
                    'kind': 'change',
                    'id': id,
                    'html': elem.innerHTML,
                    'color': mycolor,
                }));
            });
        }
        let newsection = document.getElementById('new-section');
        newsection.addEventListener('click', function () {
            ws.send(JSON.stringify({
                'kind': 'new-section',
                'id': 'main',
                'html': '',
                'color': mycolor,
            }));
        });
        // Set onclick on newrow buttons
        elems = document.querySelectorAll('.newrow');
        for (i = 0; i < elems.length; ++i) {
            let elem = elems[i];
            elem.addEventListener('click', function () {
                ws.send(JSON.stringify({
                    'kind': 'new-row',
                    'id': elem.parentElement.id,
                    'html': '',
                    'color': mycolor,
                }));
            });
        }
        // Set onclick on newitem buttons
        elems = document.querySelectorAll('.newitem');
        for (i = 0; i < elems.length; ++i) {
            let elem = elems[i];
            elem.addEventListener('click', function () {
                ws.send(JSON.stringify({
                    'kind': 'new-item',
                    'id': elem.parentElement.id,
                    'html': '',
                    'color': mycolor,
                }));
            });
        }
    };
    var timer = setTimeout(goWhite, 1000);
    ws.onmessage = function (event) {
        let msg = JSON.parse(event.data);
        console.log(msg);
        // message(msg.data);
        if (msg.kind == 'change') {
            let elem = document.getElementById(msg.id);
            if (elem && mycolor != msg.color && elem.innerHTML != msg.html) {
                clearTimeout(timer);
                timer = setTimeout(goWhite, 1000);
                elem.innerHTML = msg.html;
                elem.style.backgroundColor = msg.color;
                ws.onopen();
            }
        }
        if (msg.kind == 'replace') {
            let elem = document.getElementById(msg.id);
            if (elem) {
                let div = document.createElement('div');
                div.innerHTML = msg.html;
                div.firstChild.style.backgroundColor = msg.color;
                elem.parentElement.replaceChild(div.firstChild, elem);
                clearTimeout(timer);
                timer = setTimeout(goWhite, 1000);
                ws.onopen();
            }
        }
        if (msg.kind == 'new-section') {
            let main = document.getElementById('main');
            let div = document.createElement('div');
            div.innerHTML = msg.html;
            console.log('lastchild:', main.lastChild);
            main.insertBefore(div.firstChild, main.lastChild.previousSibling);
            ws.onopen();
        }
        if (msg.kind == 'new-row') {
            let section = document.getElementById(msg.id);
            let div = document.createElement('div');
            div.innerHTML = msg.html;
            section.appendChild(div.firstChild);
            ws.onopen();
        }
    };
    ws.onclose = function () {
        console.log('disconnected');
    };
</script>

<body>
    <main id="main">
        <header>
            <h1>[% self.name %]</h1>
        </header>
        [%
        for s in self.sections.iter() {
        s
        }
        %]
        <button id="new-section">New section</button>
    </main>
</body>

</html>